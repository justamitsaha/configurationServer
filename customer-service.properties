# =========================================
# üöÄ Basic Application Settings
# =========================================
# Logical service name used by:
#   - Eureka (for registration & discovery)
#   - Config Server (to fetch config)
#   - Spring Cloud Bus (for distributed refresh)
spring.application.name=${SPRING_APP_NAME:customer-service}

# Local port on which this service runs.
# In container platforms, override via ENV variable.
server.port=${SERVER_PORT:8081}


# =========================================
# üóÑÔ∏è Database (R2DBC + MySQL)
# =========================================
# Reactive (non-blocking) DB connection.
spring.r2dbc.url=${SPRING_R2DBC_URL:r2dbc:mysql://localhost:3306/amit?serverTimezone=Asia/Kolkata}
spring.r2dbc.username=${SPRING_R2DBC_USERNAME:root}
spring.r2dbc.password=${SPRING_R2DBC_PASSWORD:shamit2020}


# =========================================
# üîó Service-to-Service URLs
# =========================================
# Base URL for invoking Order Service.
# Uses Eureka service name ("order-service") instead of hardcoding IP/Port.
app.order-service.base-url=${ORDER_SERVICE_BASE_URL:http://order-service}


# =========================================
# üìä Management, Metrics & Observability
# =========================================
# Exposes important Actuator endpoints for monitoring & debugging.
management.endpoints.web.exposure.include=${MANAGEMENT_ENDPOINTS:health,info,metrics,prometheus,refresh,busrefresh,circuitbreakers,circuitbreakerevents,retry,retryevents,bulkheads,bulkheadevents}


# Configure HTTP request percentile + SLO metrics for performance dashboards.
management.metrics.distribution.percentiles.http.server.requests=${HTTP_SERVER_REQ_PERCENTILES:0.5,0.9,0.95,0.99}
management.metrics.distribution.slo.http.server.requests=${HTTP_SERVER_REQ_SLO:100ms,250ms,500ms,1s,2s}

# === ‚úÖ Distributed Tracing (OpenTelemetry) ===
# Trace sampling ‚Äî 1.0 = trace every request. Reduce to ~0.1 in PROD.
management.tracing.sampling.probability=${TRACING_SAMPLING:1.0}

# OTLP endpoint for sending trace data (Tempo, Jaeger, etc.)
management.tracing.export.otlp.endpoint=${OTLP_ENDPOINT:http://localhost:4318/v1/traces}


# === üßµ Spring Cloud Bus (Kafka) ===
# Used for distributed configuration refresh.
spring.kafka.bootstrap-servers=${SPRING_KAFKA_BOOTSTRAP:localhost:9092,localhost:9093,localhost:9094}


# =========================================
# üí™ Resilience4j Configuration (Fault Tolerance)
# =========================================
# Applied for WebClient call to Order Service:
# ‚úÖ Circuit Breaker ‚Äì stop calls to unstable service
# ‚úÖ Retry ‚Äì only for transient network issues
# ‚úÖ Bulkhead ‚Äì limit concurrent calls for protection
# ‚ùå TimeoutException removed from retry (fast fallback behavior)


# --- üî• Circuit Breaker ---
# Opens if 50%+ of last 6 calls fail, then stops calling for 10s.
resilience4j.circuitbreaker.instances.orderService.slidingWindowType=COUNT_BASED
resilience4j.circuitbreaker.instances.orderService.slidingWindowSize=6
resilience4j.circuitbreaker.instances.orderService.minimumNumberOfCalls=3
resilience4j.circuitbreaker.instances.orderService.failureRateThreshold=50
resilience4j.circuitbreaker.instances.orderService.waitDurationInOpenState=10s
resilience4j.circuitbreaker.instances.orderService.automaticTransitionFromOpenToHalfOpenEnabled=true
resilience4j.circuitbreaker.instances.orderService.permittedNumberOfCallsInHalfOpenState=2

# Exceptions counted as failures by the Circuit Breaker
resilience4j.circuitbreaker.instances.orderService.recordExceptions= \
  org.springframework.web.reactive.function.client.WebClientRequestException, \
  org.springframework.web.reactive.function.client.WebClientResponseException, \
  java.util.concurrent.TimeoutException


# --- üîÅ Retry ---
# Retries ONLY for transient network failures (NOT for slow responses/timeouts).
resilience4j.retry.instances.orderService.maxAttempts=2
resilience4j.retry.instances.orderService.waitDuration=100ms

# Retry only on connectivity issues (not on timeouts or 5xx)
resilience4j.retry.instances.orderService.retryExceptions= \
  org.springframework.web.reactive.function.client.WebClientRequestException


# --- üöß Bulkhead ---
# Limits concurrent calls to prevent overload or thread starvation.
resilience4j.bulkhead.instances.orderService.maxConcurrentCalls=20
resilience4j.bulkhead.instances.orderService.maxWaitDuration=200ms


# --- ‚è± Time Limiter ---
# Max allowed call duration. Reactor's .timeout() handles logic,
# but this enables metrics visibility on Actuator.
resilience4j.timelimiter.instances.orderService.timeoutDuration=2s
resilience4j.timelimiter.instances.orderService.cancelRunningFuture=false


# =========================================
# üåç Eureka Discovery Configuration
# =========================================
# Registers this service with Eureka Discovery Server.
eureka.client.service-url.defaultZone=${EUREKA_DEFAULT_ZONE:http://localhost:8761/eureka}
eureka.instance.prefer-ip-address=${EUREKA_PREFER_IP:true}


# =========================================
# üìò Swagger / OpenAPI
# =========================================
springdoc.swagger-ui.path=${SWAGGER_UI_PATH:/swagger-ui/index.html}

logging.pattern.console=${LOGGING_PATTERN_CONSOLE:%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level [%thread] %logger{36} - %msg%n}